<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Add Server</title>

    <style>
        :root {
            --bg: #f5f5f5;
            --card: #ffffff;
            --text: #111111;
            --muted: #666666;
            --border: #dddddd;
            --accent: #f2f2f2;
            --arrow: #2b7cff;
            --primary: #2b7cff;
            --danger: #cc2b2b;
        }

        @media (prefers-color-scheme: dark) {
            :root {
                --bg: #0f0f0f;
                --card: #1a1a1a;
                --text: #f2f2f2;
                --muted: #a0a0a0;
                --border: #2a2a2a;
                --accent: #f2f2f2;
                --arrow: #2b7cff;
                --primary: #2b7cff;
                --danger: #ff6b6b;
            }
        }

        * { box-sizing: border-box; }

        body {
            margin: 0;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background: var(--bg);
            color: var(--text);
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
        }

        .card {
            background: var(--card);
            padding: 2.5rem;
            border-radius: 16px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.08);
            max-width: 520px;
            width: 90%;
            text-align: left;
            border: 1px solid var(--border);
        }

        h1 {
            margin-top: 0;
            font-size: 1.6rem;
            font-weight: 600;
        }

        p {
            margin: 0.75rem 0 1.25rem;
            line-height: 1.6;
            color: var(--muted);
        }

        .step {
            display: none;
        }

        .step.active {
            display: block;
        }

        label {
            display: block;
            margin: 0.75rem 0 0.35rem;
            font-weight: 600;
            font-size: 0.95rem;
        }

        input {
            width: 100%;
            padding: 0.7rem 0.8rem;
            border-radius: 10px;
            border: 1px solid var(--border);
            background: transparent;
            color: var(--text);
            outline: none;
        }

        input:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(43, 124, 255, 0.18);
        }

        .row {
            display: flex;
            gap: 0.75rem;
            align-items: center;
            justify-content: flex-end;
            margin-top: 1.25rem;
        }

        button {
            border: 1px solid var(--border);
            background: var(--accent);
            color: var(--text);
            border-radius: 12px;
            padding: 0.7rem 1rem;
            cursor: pointer;
            font-weight: 600;
        }

        button.primary {
            border-color: rgba(43,124,255,0.35);
            background: rgba(43,124,255,0.12);
        }

        button:disabled {
            opacity: 0.6;
            cursor: default;
        }

        .error {
            margin-top: 0.75rem;
            color: var(--danger);
            display: none;
            font-size: 0.95rem;
        }

        .hint {
            font-size: 0.9rem;
            color: var(--muted);
            margin-top: 0.5rem;
        }

        .success {
            margin-top: 0.75rem;
            color: var(--muted);
            display: none;
            font-size: 0.95rem;
        }
    </style>
</head>

<body>
    <div class="card">
        <h1>Add a server</h1>
        <p id="subtitle">Enter the server IP address and the invitation token you received.</p>

        <div id="step1" class="step active" aria-label="Validate invitation">
            <form id="validateForm">
                <label for="ipAddress">IP address</label>
                <input id="ipAddress" name="ipAddress" type="text" inputmode="decimal" placeholder="192.168.1.50" autocomplete="off" required />
                <div class="hint">Include port if needed (example: 192.168.1.50:5001).</div>

                <label for="invitationToken">Invitation token</label>
                <input id="invitationToken" name="invitationToken" type="text" placeholder="XXXX-XXXX-XXXX" autocomplete="off" required />

                <div id="error1" class="error" role="alert"></div>

                <div class="row">
                    <button id="validateBtn" class="primary" type="submit">Validate</button>
                </div>
            </form>
        </div>

        <div id="step2" class="step" aria-label="Choose server name">
            <form id="acceptForm">
                <label for="serverName">Server name</label>
                <input id="serverName" name="serverName" type="text" placeholder="My Server" autocomplete="off" required />

                <div id="error2" class="error" role="alert"></div>
                <div id="success2" class="success" role="status"></div>

                <div class="row">
                    <button id="backBtn" type="button">Back</button>
                    <button id="acceptBtn" class="primary" type="submit">Add server</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        const step1 = document.getElementById('step1');
        const step2 = document.getElementById('step2');
        const subtitle = document.getElementById('subtitle');

        const validateForm = document.getElementById('validateForm');
        const ipAddress = document.getElementById('ipAddress');
        const invitationToken = document.getElementById('invitationToken');
        const validateBtn = document.getElementById('validateBtn');
        const error1 = document.getElementById('error1');

        const acceptForm = document.getElementById('acceptForm');
        const serverName = document.getElementById('serverName');
        const acceptBtn = document.getElementById('acceptBtn');
        const backBtn = document.getElementById('backBtn');
        const error2 = document.getElementById('error2');
        const success2 = document.getElementById('success2');

        function hostAvailable() {
            return !!(window.chrome && window.chrome.webview);
        }

        function show(el) { el.classList.add('active'); }
        function hide(el) { el.classList.remove('active'); }

        function showError(target, message) {
            target.textContent = message || '';
            target.style.display = message ? 'block' : 'none';
        }

        function showSuccess(message) {
            success2.textContent = message || '';
            success2.style.display = message ? 'block' : 'none';
        }

        function goToStep1() {
            show(step1);
            hide(step2);
            subtitle.textContent = 'Enter the server IP address and the invitation token you received.';
            showError(error2, '');
            showSuccess('');
        }

        function goToStep2() {
            hide(step1);
            show(step2);
            subtitle.textContent = 'Invitation validated. Choose a name for this server.';
            serverName.focus();
        }

        validateForm.addEventListener('submit', (ev) => {
            ev.preventDefault();
            showError(error1, '');

            const ip = (ipAddress.value || '').trim();
            const token = (invitationToken.value || '').trim();

            if (!ip) {
                showError(error1, 'Please enter an IP address.');
                ipAddress.focus();
                return;
            }

            if (!token) {
                showError(error1, 'Please enter an invitation token.');
                invitationToken.focus();
                return;
            }

            if (!hostAvailable()) {
                showError(error1, 'This page must be hosted in the desktop client.');
                return;
            }

            validateBtn.disabled = true;
            window.chrome.webview.postMessage({
                type: 'addServer',
                payload: { ipAddress: ip, invitationToken: token }
            });

            // Host will respond via postMessage; keep UI responsive.
            setTimeout(() => { validateBtn.disabled = false; }, 1000);
        });

        backBtn.addEventListener('click', () => {
            goToStep1();
        });

        acceptForm.addEventListener('submit', (ev) => {
            ev.preventDefault();
            showError(error2, '');
            showSuccess('');

            const name = (serverName.value || '').trim();
            if (!name) {
                showError(error2, 'Please enter a name.');
                serverName.focus();
                return;
            }

            if (!hostAvailable()) {
                showError(error2, 'This page must be hosted in the desktop client.');
                return;
            }

            acceptBtn.disabled = true;
            window.chrome.webview.postMessage({
                type: 'addServer/accept',
                payload: { name }
            });

            setTimeout(() => { acceptBtn.disabled = false; }, 1000);
        });

        // Receive host responses
        if (hostAvailable()) {
            window.chrome.webview.addEventListener('message', (event) => {
                const msg = event.data || {};
                const type = (msg.type || '').toLowerCase();
                const payload = msg.payload || {};

                if (type === 'addserver/validated') {
                    if (payload.ok) {
                        goToStep2();
                    } else {
                        showError(error1, payload.message || 'Invitation is not valid.');
                    }
                }

                if (type === 'addserver/accepted') {
                    if (payload.ok) {
                        showSuccess('Server added. Connecting...');
                    } else {
                        showError(error2, payload.message || 'Failed to add server.');
                    }
                }
            });
        }
    </script>
</body>
</html>
